<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>Jenkins插件版本管理 - 张三说</title><meta name=Description content><meta property="og:title" content="Jenkins插件版本管理">
<meta property="og:description" content="基本方法 控制变量法 二分法 查找信息源头，Read The Fucking Source Code(时间成本高，需结合谷歌大法） 问题现象 Jenkins Kubernetes plugin不工作，不断创建新POD，">
<meta property="og:type" content="article">
<meta property="og:url" content="https://zhan9san.github.io/posts/jenkins-plugin-version-management/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-10-10T16:04:55+08:00">
<meta property="article:modified_time" content="2021-10-10T16:04:55+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Jenkins插件版本管理">
<meta name=twitter:description content="基本方法 控制变量法 二分法 查找信息源头，Read The Fucking Source Code(时间成本高，需结合谷歌大法） 问题现象 Jenkins Kubernetes plugin不工作，不断创建新POD，">
<meta name=application-name content="张三说">
<meta name=apple-mobile-web-app-title content="张三说"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://zhan9san.github.io/posts/jenkins-plugin-version-management/><link rel=prev href=https://zhan9san.github.io/posts/code-vs-algebra/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Jenkins插件版本管理","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/zhan9san.github.io\/posts\/jenkins-plugin-version-management\/"},"genre":"posts","wordcount":2987,"url":"https:\/\/zhan9san.github.io\/posts\/jenkins-plugin-version-management\/","datePublished":"2021-10-10T16:04:55+08:00","dateModified":"2021-10-10T16:04:55+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"作者"},"author":{"@type":"Person","name":"作者"},"description":""}</script></head>
<body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title=张三说>张三说</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> 所有文章 </a><a class=menu-item href=/tags/> 标签 </a><a class=menu-item href=/categories/> 分类 </a><a class=menu-item href=https://github.com/zhan9san title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i> </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title=张三说>张三说</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=https://github.com/zhan9san title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>目录</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animated flipInX">Jenkins插件版本管理</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=/ title=Author rel=" author" class=author><i class="fas fa-user-circle fa-fw"></i>作者</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-10-10>2021-10-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2987 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 6 分钟&nbsp;<span id=/posts/jenkins-plugin-version-management/ class=leancloud_visitors data-flag-title=Jenkins插件版本管理>
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div>
</div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#问题现象>问题现象</a></li>
<li><a href=#如何快速修复问题>如何快速修复问题</a></li>
<li><a href=#构建可以复现问题的最小环境>构建可以复现问题的最小环境</a></li>
<li><a href=#复现问题>复现问题</a></li>
<li><a href=#确定问题修复的版本>确定问题修复的版本</a></li>
<li><a href=#查找问题原因>查找问题原因</a></li>
<li><a href=#验证修复问题环境>验证修复问题环境</a></li>
<li><a href=#进一步思考>进一步思考</a></li>
<li><a href=#参考>参考</a></li>
</ul>
</nav></div>
</div><div class=content id=content><p>基本方法</p>
<ul>
<li>控制变量法</li>
<li>二分法</li>
<li>查找信息源头，Read The Fucking Source Code(时间成本高，需结合谷歌大法）</li>
</ul>
<h2 id=问题现象>问题现象</h2>
<p>Jenkins Kubernetes plugin不工作，不断创建新POD，但是不执行pipeline中的step</p>
<p>Jenkins version: 2.263.1-lts</p>
<p>Kubernetes plugin version: 1.28.4</p>
<h2 id=如何快速修复问题>如何快速修复问题</h2>
<p>尝试升级版本</p>
<p>控制变量法: kubernetes集群版本不变，Jenkins版本不变，只升级kubernetes插件到最新版本（1.30.3）。
升级后，一切运行正常。<code>It just works</code>，但是看起来太简单了。升级可能影响其他插件工作</p>
<p>你是专业的，就不要干业余的人也能轻易做到的事 &ndash;《李诞脱口秀工作手册》</p>
<p>尝试取法其上</p>
<h2 id=构建可以复现问题的最小环境>构建可以复现问题的最小环境</h2>
<p>创建一个干净的Jenkins服务，使用<a href="https://hub.docker.com/layers/jenkins/jenkins/2.263.1-lts/images/sha256-1433deaac433ce20c534d8b87fcd0af3f25260f375f4ee6bdb41d70e1769d9ce?context=explore" target=_blank rel="noopener noreffer">jenkins/jenkins:2.263.1-lts</a>作为基础镜像，并使用该镜像中自带的插件工
具安装<a href=https://github.com/jenkinsci/kubernetes-plugin/releases/tag/kubernetes-1.28.4 target=_blank rel="noopener noreffer">kubernetes:1.28.4</a></p>
<ol>
<li>
<p>准备<code>Dockerfile</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile>$ cat Dockerfile<span class=err>
</span><span class=err></span><span class=k>FROM</span><span class=s> jenkins/jenkins:2.263.1-lts</span><span class=err>
</span><span class=err></span><span class=k>ENV</span> JAVA_OPTS -Djenkins.install.runSetupWizard<span class=o>=</span>false<span class=err>
</span><span class=err></span><span class=k>RUN</span> jenkins-plugin-cli -p kubernetes:1.28.4 workflow-aggregator<span class=err>
</span></code></pre></div></li>
<li>
<p>构建测试镜像</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>docker build -t jenkins:test .
</code></pre></div></li>
<li>
<p>启动测试Jenkins</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>docker run -p 8080:8080 -p 5000:5000 jenkins:test
</code></pre></div></li>
<li>
<p>配置kubernetes</p>
</li>
<li>
<p>测试pipline job</p>
<pre tabindex=0><code class=language-pipeline data-lang=pipeline>pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
spec:
containers:
- name: shell
    image: busybox
    command:
    - sleep
    args:
    - infinity
'''
            defaultContainer 'shell'
        }
    }
    stages {
        stage('Main') {
            steps {
                sh 'hostname'
            }
        }
    }
}
</code></pre></li>
</ol>
<h2 id=复现问题>复现问题</h2>
<p>运行pipeline，Jenkins job的console output如下，强制终止该job，否则会一直创建新的pod，且
错误的pod不会被删除，如没有配置quota，最终kubernetes集群资源会被耗尽</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text>Started by user unknown or anonymous
Running in Durability level: MAX_SURVIVABILITY
[Pipeline] Start of Pipeline
[Pipeline] podTemplate
[Pipeline] {
[Pipeline] node
Created Pod: kubernetes default/test-2-3cgsd-hbsnq-szzdm
Created Pod: kubernetes default/test-2-3cgsd-hbsnq-x5k2k
Still waiting to schedule task
‘Jenkins’ doesn’t have label ‘test_2-3cgsd’
Created Pod: kubernetes default/test-2-3cgsd-hbsnq-6mvbv
Created Pod: kubernetes default/test-2-3cgsd-hbsnq-njc0l
Created Pod: kubernetes default/test-2-3cgsd-hbsnq-4lgpq
Created Pod: kubernetes default/test-2-3cgsd-hbsnq-r9rkr
Created Pod: kubernetes default/test-2-3cgsd-hbsnq-grm03
Aborted by unknown
[Pipeline] // node
[Pipeline] }
[Pipeline] // podTemplate
[Pipeline] End of Pipeline
Finished: ABORTED
</code></pre></div><h2 id=确定问题修复的版本>确定问题修复的版本</h2>
<p>二分法</p>
<p>无问题版本kubernetes-plugin:1.30.3</p>
<p>有问题版本kubernetes-plugin:1.28.4</p>
<p><a href=https://github.com/jenkinsci/kubernetes-plugin/releases target=_blank rel="noopener noreffer">列出版本</a></p>
<p>1.30.3, 1.30.2, 1.30.2, 1.27.8, 1.30.0, 1.29.7, &mldr; , 1.28.5, 1.28.4</p>
<p>经过一番测试，最终确定修复问题最小版本为1.30.0。被<code>Read The Fucking Source Code</code>支配的大脑
尝试对比1.30.0和1.29.7的版本源码差异，发现依赖的<code>kubernetes-client-api</code>由<code>4.13.2-1</code>变为<code>5.4.1</code>。
此变更可能是问题的根本原因，但条件还不够充分</p>
<h2 id=查找问题原因>查找问题原因</h2>
<p>查看Jenkins日志。关键日志<code>Refusing headers from remote: Unknown client name: </code>，
据google大法，是由于jenkins agent中的pod运行失败导致Jenkins不识别该agent（此段仍待考证，但不
影响进一步分析），同时发现未解决的issue，<a href=https://issues.jenkins.io/browse/JENKINS-54683 target=_blank rel="noopener noreffer">JENKINS-54683</a></p>
<pre tabindex=0><code class=language-log data-lang=log>2021-10-10 10:25:27.071+0000 [id=30]	INFO	o.c.j.p.k.KubernetesCloud#provision: Label &quot;test_2-3cgsd&quot; excess workload: 1, executors: 0, plannedCapacity: 0, launching: 0
2021-10-10 10:25:28.095+0000 [id=227]	WARNING	i.f.kubernetes.client.Config#tryServiceAccount: Error reading service account token from: [/var/run/secrets/kubernetes.io/serviceaccount/token]. Ignoring.
2021-10-10 10:25:28.100+0000 [id=228]	INFO	hudson.slaves.NodeProvisioner#lambda$update$6: test-2-3cgsd-hbsnq-4lgpq provisioning successfully completed. We have now 2 computer(s)
2021-10-10 10:25:28.119+0000 [id=227]	INFO	o.c.j.p.k.KubernetesLauncher#launch: Created Pod: kubernetes default/test-2-3cgsd-hbsnq-4lgpq
2021-10-10 10:25:28.120+0000 [id=227]	WARNING	o.c.j.p.k.KubernetesLauncher#launch: Error in provisioning; agent=KubernetesSlave name: test-2-3cgsd-hbsnq-4lgpq, template=PodTemplate{id='e96857aa-b41c-4fc3-b210-5232a5a68bd6', name='test_2-3cgsd-hbsnq', label='test_2-3cgsd', annotations=[PodAnnotation{key='buildUrl', value='http://192.168.31.115:8080/job/test/2/'}, PodAnnotation{key='runUrl', value='job/test/2/'}]}
java.lang.NoSuchMethodError: io.fabric8.kubernetes.client.dsl.PodResource.watch(Ljava/lang/Object;)Ljava/lang/Object;
    at org.csanchez.jenkins.plugins.kubernetes.KubernetesLauncher.launch(KubernetesLauncher.java:159)
    at hudson.slaves.SlaveComputer.lambda$_connect$0(SlaveComputer.java:294)
    at jenkins.util.ContextResettingExecutorService$2.call(ContextResettingExecutorService.java:46)
    at jenkins.security.ImpersonatingExecutorService$2.call(ImpersonatingExecutorService.java:71)
    at java.util.concurrent.FutureTask.run(FutureTask.java:266)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
    at java.lang.Thread.run(Thread.java:748)
2021-10-10 10:25:28.120+0000 [id=227]	INFO	o.c.j.p.k.KubernetesSlave#_terminate: Terminating Kubernetes instance for agent test-2-3cgsd-hbsnq-4lgpq
2021-10-10 10:25:32.300+0000 [id=257]	INFO	h.TcpSlaveAgentListener$ConnectionHandler#run: Connection #15 failed: java.io.EOFException
2021-10-10 10:25:32.354+0000 [id=258]	INFO	h.TcpSlaveAgentListener$ConnectionHandler#run: Accepted JNLP4-connect connection #16 from /172.17.0.1:62916
2021-10-10 10:25:32.441+0000 [id=227]	INFO	o.j.r.p.i.ConnectionHeadersFilterLayer#onRecv: [JNLP4-connect connection from 172.17.0.1/172.17.0.1:62916] Refusing headers from remote: Unknown client name: test-2-3cgsd-hbsnq-4lgpq
2021-10-10 10:25:37.072+0000 [id=34]	INFO	o.c.j.p.k.KubernetesCloud#provision: Label &quot;test_2-3cgsd&quot; excess workload: 1, executors: 0, plannedCapacity: 0, launching: 0
</code></pre><p>进一步查看pod日志，发现类似错误信息<code>Local headers refused by remote: Unknown client name:</code>。</p>
<pre tabindex=0><code class=language-log data-lang=log>$ kubectl logs test-2-3cgsd-hbsnq-4lgpq jnlp
Oct 10, 2021 10:25:32 AM hudson.remoting.jnlp.Main createEngine
INFO: Setting up agent: test-2-3cgsd-hbsnq-4lgpq
Oct 10, 2021 10:25:32 AM hudson.remoting.jnlp.Main$CuiListener &lt;init&gt;
INFO: Jenkins agent is running in headless mode.
Oct 10, 2021 10:25:32 AM hudson.remoting.Engine startEngine
INFO: Using Remoting version: 4.3
Oct 10, 2021 10:25:32 AM org.jenkinsci.remoting.engine.WorkDirManager initializeWorkDir
INFO: Using /home/jenkins/agent/remoting as a remoting work directory
Oct 10, 2021 10:25:32 AM org.jenkinsci.remoting.engine.WorkDirManager setupLogging
INFO: Both error and output logs will be printed to /home/jenkins/agent/remoting
Oct 10, 2021 10:25:32 AM hudson.remoting.jnlp.Main$CuiListener status
INFO: Locating server among [http://192.168.31.115:8080/]
Oct 10, 2021 10:25:32 AM org.jenkinsci.remoting.engine.JnlpAgentEndpointResolver resolve
INFO: Remoting server accepts the following protocols: [JNLP4-connect, Ping]
Oct 10, 2021 10:25:32 AM hudson.remoting.jnlp.Main$CuiListener status
INFO: Agent discovery successful
Agent address: 192.168.31.115
Agent port:    50000
Identity:      02:ba:f1:1a:79:a5:cf:47:cb:72:8e:d6:5a:46:50:57
Oct 10, 2021 10:25:32 AM hudson.remoting.jnlp.Main$CuiListener status
INFO: Handshaking
Oct 10, 2021 10:25:32 AM hudson.remoting.jnlp.Main$CuiListener status
INFO: Connecting to 192.168.31.115:50000
Oct 10, 2021 10:25:32 AM hudson.remoting.jnlp.Main$CuiListener status
INFO: Trying protocol: JNLP4-connect
Oct 10, 2021 10:25:32 AM hudson.remoting.jnlp.Main$CuiListener status
INFO: Remote identity confirmed: 02:ba:f1:1a:79:a5:cf:47:cb:72:8e:d6:5a:46:50:57
Oct 10, 2021 10:25:32 AM org.jenkinsci.remoting.protocol.impl.ConnectionHeadersFilterLayer onRecv
INFO: [JNLP4-connect connection to 192.168.31.115/192.168.31.115:50000] Local headers refused by remote: Unknown client name: test-2-3cgsd-hbsnq-4lgpq
Oct 10, 2021 10:25:32 AM hudson.remoting.jnlp.Main$CuiListener status
INFO: Protocol JNLP4-connect encountered an unexpected exception
java.util.concurrent.ExecutionException: org.jenkinsci.remoting.protocol.impl.ConnectionRefusalException: Unknown client name: test-2-3cgsd-hbsnq-4lgpq
    at org.jenkinsci.remoting.util.SettableFuture.get(SettableFuture.java:223)
    at hudson.remoting.Engine.innerRun(Engine.java:743)
    at hudson.remoting.Engine.run(Engine.java:518)
Caused by: org.jenkinsci.remoting.protocol.impl.ConnectionRefusalException: Unknown client name: test-2-3cgsd-hbsnq-4lgpq
    at org.jenkinsci.remoting.protocol.impl.ConnectionHeadersFilterLayer.newAbortCause(ConnectionHeadersFilterLayer.java:378)
    at org.jenkinsci.remoting.protocol.impl.ConnectionHeadersFilterLayer.onRecvClosed(ConnectionHeadersFilterLayer.java:433)
    at org.jenkinsci.remoting.protocol.ProtocolStack$Ptr.onRecvClosed(ProtocolStack.java:816)
    at org.jenkinsci.remoting.protocol.FilterLayer.onRecvClosed(FilterLayer.java:287)
    at org.jenkinsci.remoting.protocol.impl.SSLEngineFilterLayer.onRecvClosed(SSLEngineFilterLayer.java:172)
    at org.jenkinsci.remoting.protocol.ProtocolStack$Ptr.onRecvClosed(ProtocolStack.java:816)
    at org.jenkinsci.remoting.protocol.NetworkLayer.onRecvClosed(NetworkLayer.java:154)
    at org.jenkinsci.remoting.protocol.impl.BIONetworkLayer.access$1500(BIONetworkLayer.java:48)
    at org.jenkinsci.remoting.protocol.impl.BIONetworkLayer$Reader.run(BIONetworkLayer.java:247)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
    at hudson.remoting.Engine$1.lambda$newThread$0(Engine.java:117)
    at java.lang.Thread.run(Thread.java:748)
    Suppressed: java.nio.channels.ClosedChannelException
        ... 7 more

Oct 10, 2021 10:25:32 AM hudson.remoting.jnlp.Main$CuiListener error
SEVERE: The server rejected the connection: None of the protocols were accepted
java.lang.Exception: The server rejected the connection: None of the protocols were accepted
    at hudson.remoting.Engine.onConnectionRejected(Engine.java:828)
    at hudson.remoting.Engine.innerRun(Engine.java:768)
    at hudson.remoting.Engine.run(Engine.java:518)
</code></pre><p><code>kubernetes plugin</code>还有更详细的日志吗？尝试从<a href=https://github.com/jenkinsci/kubernetes-plugin target=_blank rel="noopener noreffer">官网</a>找答案。</p>
<blockquote>
<p>For more detail, configure a new Jenkins log recorder for org.csanchez.jenkins.plugins.kubernetes at ALL level.</p>
</blockquote>
<p>尝试配置新的<a href=https://support.cloudbees.com/hc/en-us/articles/204880580-How-do-I-create-a-logger-in-Jenkins-for-troubleshooting-and-diagnostic-information- target=_blank rel="noopener noreffer">log recorder</a>后，再次运行该job，<code>Log records</code>如下</p>
<pre tabindex=0><code class=language-log data-lang=log>Creating Pod: kubernetes default/test-3-5zkhw-l3pmd-jmjh7
Oct 10, 2021 10:58:46 AM INFO org.csanchez.jenkins.plugins.kubernetes.KubernetesLauncher launch
Created Pod: kubernetes default/test-3-5zkhw-l3pmd-jmjh7
Oct 10, 2021 10:58:46 AM WARNING org.csanchez.jenkins.plugins.kubernetes.KubernetesLauncher launch
Error in provisioning; agent=KubernetesSlave name: test-3-5zkhw-l3pmd-jmjh7, template=PodTemplate{id='0d4eb474-ffa3-475e-b0dd-1a0bfda5b44b', name='test_3-5zkhw-l3pmd', label='test_3-5zkhw', annotations=[PodAnnotation{key='buildUrl', value='http://192.168.31.115:8080/job/test/3/'}, PodAnnotation{key='runUrl', value='job/test/3/'}]}
java.lang.NoSuchMethodError: io.fabric8.kubernetes.client.dsl.PodResource.watch(Ljava/lang/Object;)Ljava/lang/Object;
	at org.csanchez.jenkins.plugins.kubernetes.KubernetesLauncher.launch(KubernetesLauncher.java:159)
	at hudson.slaves.SlaveComputer.lambda$_connect$0(SlaveComputer.java:294)
	at jenkins.util.ContextResettingExecutorService$2.call(ContextResettingExecutorService.java:46)
	at jenkins.security.ImpersonatingExecutorService$2.call(ImpersonatingExecutorService.java:71)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)

Oct 10, 2021 10:58:46 AM FINER org.csanchez.jenkins.plugins.kubernetes.KubernetesLauncher
Removing Jenkins node: test-3-5zkhw-l3pmd-jmjh7
Oct 10, 2021 10:58:46 AM INFO org.csanchez.jenkins.plugins.kubernetes.KubernetesSlave _terminate
Terminating Kubernetes instance for agent test-3-5zkhw-l3pmd-jmjh7
Oct 10, 2021 10:58:46 AM FINEST org.csanchez.jenkins.plugins.kubernetes.KubernetesCloud
Building connection to Kubernetes kubernetes URL https://192.168.31.115:8443 namespace null
Oct 10, 2021 10:58:46 AM FINE org.csanchez.jenkins.plugins.kubernetes.KubernetesCloud
Connected to Kubernetes kubernetes URL https://192.168.31.115:8443/ namespace null
</code></pre><p>关键信息，<code>java.lang.NoSuchMethodError: io.fabric8.kubernetes.client.dsl.PodResource.watch(Ljava/lang/Object;)Ljava/lang/Object;</code>。以上信息显示是kubernetes client代码报错</p>
<p>jenkins plugin manager显示kubernetes client版本是5.4.1。</p>
<p>查看<a href=https://github.com/jenkinsci/kubernetes-plugin/blob/kubernetes-1.28.4/pom.xml#L61 target=_blank rel="noopener noreffer">kubernetes plugin依赖的plugin版本</a></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml>    <span class=nt>&lt;dependency&gt;</span>
      <span class=nt>&lt;groupId&gt;</span>org.jenkins-ci.plugins<span class=nt>&lt;/groupId&gt;</span>
      <span class=nt>&lt;artifactId&gt;</span>kubernetes-client-api<span class=nt>&lt;/artifactId&gt;</span>
      <span class=nt>&lt;version&gt;</span>4.11.1<span class=nt>&lt;/version&gt;</span>
    <span class=nt>&lt;/dependency&gt;</span>
</code></pre></div><p>由此怀疑是<code>kubernetes:1.28.4</code>插件和<code>kubernetes-client-api:5.4.1</code>插件版本不兼容导致。</p>
<p>可是为什么<code>jenkins-plugin-cli</code>不按指定的依赖版本<code>4.11.1</code>安装，而是选择<code>5.4.1</code>呢？</p>
<p>尝试指定<code>kubernetes-client-api:4.11.1</code>，修改Dockerfile如下</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile>$ cat Dockerfile<span class=err>
</span><span class=err></span><span class=k>FROM</span><span class=s> jenkins/jenkins:2.263.1-lts</span><span class=err>
</span><span class=err></span><span class=k>ENV</span> JAVA_OPTS -Djenkins.install.runSetupWizard<span class=o>=</span>false<span class=err>
</span><span class=err></span><span class=k>RUN</span> jenkins-plugin-cli -p kubernetes:1.28.4 kubernetes-client-api:4.11.1 workflow-aggregator<span class=err>
</span></code></pre></div><p>重新构建镜像</p>
<pre tabindex=0><code>$ docker build -t jenkins:test .
[+] Building 13.1s (5/5) FINISHED
 =&gt; [internal] load build definition from Dockerfile                                                                                                         0.0s
 =&gt; =&gt; transferring dockerfile: 232B                                                                                                                         0.0s
 =&gt; [internal] load .dockerignore                                                                                                                            0.0s
 =&gt; =&gt; transferring context: 34B                                                                                                                             0.0s
 =&gt; [internal] load metadata for docker.io/jenkins/jenkins:2.263.1-lts                                                                                       0.0s
 =&gt; CACHED [1/2] FROM docker.io/jenkins/jenkins:2.263.1-lts                                                                                                  0.0s
 =&gt; ERROR [2/2] RUN jenkins-plugin-cli -p kubernetes:1.28.4 kubernetes-client-api:4.11.1 workflow-aggregator                                                13.0s
------
 &gt; [2/2] RUN jenkins-plugin-cli -p kubernetes:1.28.4 kubernetes-client-api:4.11.1 workflow-aggregator:
#5 12.87 Plugin kubernetes:1.28.4 depends on kubernetes-client-api:5.4.1, but there is an older version defined on the top level - kubernetes-client-api:4.11.1
------
executor failed running [/bin/sh -c jenkins-plugin-cli -p kubernetes:1.28.4 kubernetes-client-api:4.11.1 workflow-aggregator]: exit code: 1
</code></pre><p>为什么<code>kubernetes</code>插件指定的依赖版本是<code>4.11.1</code>，却依然会报错呢？</p>
<p>尝试查看<code>jenkins-plugin-cli</code>的源码，它从哪里来呢？</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ docker run --rm -it --entrypoint /bin/bash jenkins/jenkins:2.263.1-lts
jenkins@503e021bb290:/$ which jenkins-plugin-cli
/bin/jenkins-plugin-cli
jenkins@503e021bb290:/$ cat /bin/jenkins-plugin-cli
<span class=c1>#!/usr/bin/env bash</span>

java -jar /usr/lib/jenkins-plugin-manager.jar <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span>

</code></pre></div><p>只需查看<code>jenkins-plugin-manager.jar</code>即可，在<a href=hub.docker.com rel>docker hub</a>搜索<code>jenkins/jenkins</code>,
再搜索tag(2.263.1-lts)，到<a href="https://hub.docker.com/layers/jenkins/jenkins/2.263.1-lts/images/sha256-1433deaac433ce20c534d8b87fcd0af3f25260f375f4ee6bdb41d70e1769d9ce?context=explore" target=_blank rel="noopener noreffer">IMAGE LAYERS</a>,
结合<a href=https://github.com/jenkinsci/docker/blob/master/8/debian/bullseye/hotspot/Dockerfile target=_blank rel="noopener noreffer">Jenkins Dockerfile</a>可获取如下关键信息</p>
<blockquote>
<p>ARG PLUGIN_CLI_URL=https://github.com/jenkinsci/plugin-installation-manager-tool/releases/download/2.2.0/jenkins-plugin-manager-2.2.0.jar</p>
</blockquote>
<p>继续尝试二分法，获取修复版本依赖问题最小版本</p>
<p>2.11.0, 2.10.2, 2.9.3, &mldr; , 2.2.0</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ docker run --rm -it --entrypoint /bin/bash jenkins/jenkins:2.263.1-lts
jenkins@503e021bb290:/$ <span class=nb>cd</span> tmp
jenkins@503e021bb290:/$ wget https://github.com/jenkinsci/plugin-installation-manager-tool/releases/download/2.11.0/jenkins-plugin-manager-2.11.0.jar
jenkins@503e021bb290:/$ java -jar jenkins-plugin-manager-2.10.1.jar --verbose -p kubernetes:1.28.4 kubernetes-client-api:4.11.1
</code></pre></div><p>经过一番测试，最终确定修复问题最小版本为2.10.1，查看<a href=https://github.com/jenkinsci/plugin-installation-manager-tool/releases/tag/2.10.1 target=_blank rel="noopener noreffer">Release log</a>，是<a href=https://github.com/jenkinsci/plugin-installation-manager-tool/pull/359 target=_blank rel="noopener noreffer">此PR, Latest true respect pinned versions</a>顺带修复了此问题。但是如果不显式指定<code>kubernetes-client-api:4.11.1</code>，该工具依然会安装最新版本依赖。也就是说如果要规避此问题，安装<code>kubernetes:1.28.4</code>时需显式指定<code>kubernetes-client-api:4.11.1</code>。</p>
<h2 id=验证修复问题环境>验证修复问题环境</h2>
<ol>
<li>
<p>准备<code>Dockerfile</code>
覆盖基础镜像中的<code>jenkins-plugin-manager</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile>$ cat Dockerfile<span class=err>
</span><span class=err></span><span class=k>FROM</span><span class=s> jenkins/jenkins:2.263.1-lts</span><span class=err>
</span><span class=err></span><span class=k>ENV</span> JAVA_OPTS -Djenkins.install.runSetupWizard<span class=o>=</span>false<span class=err>
</span><span class=err></span><span class=k>RUN</span> curl -fsSL https://github.com/jenkinsci/plugin-installation-manager-tool/releases/download/2.10.1/jenkins-plugin-manager-2.10.1.jar -o /usr/lib/jenkins-plugin-manager.jar<span class=err>
</span><span class=err></span><span class=k>RUN</span> jenkins-plugin-cli -p kubernetes:1.28.4 workflow-aggregator<span class=err>
</span></code></pre></div></li>
<li>
<p>参考<code>构建可以复现问题的最小环境</code>章节，重新测试，问题解决</p>
</li>
</ol>
<h2 id=进一步思考>进一步思考</h2>
<p>为何总是默认安装最新版本的依赖而不是安装插件<a href=https://github.com/jenkinsci/kubernetes-plugin/blob/kubernetes-1.28.4/pom.xml#L61 target=_blank rel="noopener noreffer">指定版本的依赖</a>呢?</p>
<p>假定场景：</p>
<ul>
<li>Update Center中插件X的最新版本是3.0.0</li>
<li>插件A(1.0.0)源码中指定依赖插件X(1.0.0)</li>
<li>插件C(1.0.0)源码中指定依赖插件X(2.0.0)</li>
</ul>
<p>如果需要同时安装插件A(1.0.0)和插件C(1.0.0)，该安装哪个版本的插件X？</p>
<p>需要再啃Jenkins工作方式和java代码，但到此，已有收获，升级插件需谨慎</p>
<h2 id=参考>参考</h2>
<p><a href=https://github.com/jenkinsci/kubernetes-plugin target=_blank rel="noopener noreffer">Kubernetes plugin for Jenkins</a></p>
<p><a href=https://github.com/jenkinsci/docker target=_blank rel="noopener noreffer">Official Jenkins Docker image</a></p>
<p><a href=https://github.com/jenkinsci/plugin-installation-manager-tool target=_blank rel="noopener noreffer">Plugin Installation Manager Tool for Jenkins</a></p>
<p><a href=https://support.cloudbees.com/hc/en-us/articles/204880580-How-do-I-create-a-logger-in-Jenkins-for-troubleshooting-and-diagnostic-information- target=_blank rel="noopener noreffer">How do I create a logger in Jenkins for troubleshooting and diagnostic information?</a></p>
</div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>更新于 2021-10-10</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md></div>
<div class=post-info-share>
<span></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span>
</section>
</div>
<div class=post-nav><a href=/posts/code-vs-algebra/ class=prev rel=prev title=代码和代数><i class="fas fa-angle-left fa-fw"></i>代码和代数</a></div>
</div>
<div id=comments><div id=valine class=comment></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.88.1">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部>
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论>
<i class="fas fa-comment fa-fw"></i>
</a>
</div><link rel=stylesheet href=/lib/valine/valine.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{valine:{appId:"RSO4cUk5NJ6UDgY94fRmwv5C-MdYXbMMI",appKey:"tCk0Eo9fRhcUwfprNMNkTa1w",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-cn",pageSize:10,placeholder:"你的评论 ...",recordIP:!0,visitor:!0}}}</script><script type=text/javascript src=/js/theme.min.js></script></body>
</html>